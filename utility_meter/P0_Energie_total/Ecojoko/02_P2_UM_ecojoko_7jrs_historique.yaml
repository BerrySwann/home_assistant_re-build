# ╭──────────────────────────────────────────────────────────────────────────────╮
# │ SENSOR : PÔLE 2. ECOJOKO — SNAPSHOT J-2 À J-7 (CASCADE 23:59:55)            │
# ╰──────────────────────────────────────────────────────────────────────────────╯
#
# ⚠️  CE FICHIER EST UN TEMPLATE TRIGGER — inclus sous 'template:'
#     dans configuration.yaml via: template: !include_dir_merge_list templates/
#
# LOGIQUE GENERALE :
#   J-0  → sensor.ecojoko_reseau_quotidien_um (live, utility_meter)
#   J-1  → state_attr('sensor.ecojoko_reseau_quotidien_um', 'last_period') (natif UM)
#   J-2 à J-7 → cascade snapshot ci-dessous
#
# DÉCLENCHEMENT : 23:59:55 chaque jour
#   → Toutes les évaluations utilisent les valeurs PRE-TRIGGER (cascade garantie)
#   → J7 lit J6 AVANT que J6 soit mis à jour, etc.
#
# REDÉMARRAGE HA :
#   → restore: true sur chaque sensor = HA relit la dernière valeur depuis la DB
#   → Les sensors ne tombent PAS en 'unavailable' après un reboot
#   → Nécessite que le sensor ait déjà été déclenché au moins une fois (unique_id requis)
#
# SOURCES PAR NIVEAU :
#   ecojoko_j2_kwh  ← last_period de ecojoko_reseau_quotidien_um (= total d'hier)
#   ecojoko_j3_kwh  ← ecojoko_j2_kwh
#   ...
#   ecojoko_j7_kwh  ← ecojoko_j6_kwh (= même jour semaine dernière)
#
# BOOTSTRAP (1ère installation) :
#   J-2 est disponible dès le 1er soir (last_period du UM)
#   J-3..J-7 se remplissent progressivement sur 6 jours
#   Après 7 jours : toutes les valeurs sont cohérentes
#
# ┌───────────────────────────────────┐
# │ 10. AUTRE (Ecojoko / Linky)       │
# └───────────────────────────────────┘

- trigger:
    - platform: time
      at: "23:59:55"

  sensor:

    # ─── TOTAL kWh ──────────────────────────────────────────────────────────

    # --- ecojoko_j2_kwh ---
    # Capture J-1 (last_period du UM) → devient J-2 demain
    - name: "Ecojoko J2 kWh"
      unique_id: ecojoko_j2_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ state_attr('sensor.ecojoko_reseau_quotidien_um', 'last_period') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=2)).strftime('%A %d/%m') }}"
        hp_kwh: >
          {{ state_attr('sensor.ecojoko_hp_reseau_quotidien_um', 'last_period') | float(0) | round(2) }}
        hc_kwh: >
          {{ state_attr('sensor.ecojoko_hc_reseau_quotidien_um', 'last_period') | float(0) | round(2) }}

    # --- ecojoko_j3_kwh ---
    - name: "Ecojoko J3 kWh"
      unique_id: ecojoko_j3_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ states('sensor.ecojoko_j2_kwh') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=3)).strftime('%A %d/%m') }}"
        hp_kwh: "{{ state_attr('sensor.ecojoko_j2_kwh', 'hp_kwh') | float(0) | round(2) }}"
        hc_kwh: "{{ state_attr('sensor.ecojoko_j2_kwh', 'hc_kwh') | float(0) | round(2) }}"

    # --- ecojoko_j4_kwh ---
    - name: "Ecojoko J4 kWh"
      unique_id: ecojoko_j4_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ states('sensor.ecojoko_j3_kwh') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=4)).strftime('%A %d/%m') }}"
        hp_kwh: "{{ state_attr('sensor.ecojoko_j3_kwh', 'hp_kwh') | float(0) | round(2) }}"
        hc_kwh: "{{ state_attr('sensor.ecojoko_j3_kwh', 'hc_kwh') | float(0) | round(2) }}"

    # --- ecojoko_j5_kwh ---
    - name: "Ecojoko J5 kWh"
      unique_id: ecojoko_j5_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ states('sensor.ecojoko_j4_kwh') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=5)).strftime('%A %d/%m') }}"
        hp_kwh: "{{ state_attr('sensor.ecojoko_j4_kwh', 'hp_kwh') | float(0) | round(2) }}"
        hc_kwh: "{{ state_attr('sensor.ecojoko_j4_kwh', 'hc_kwh') | float(0) | round(2) }}"

    # --- ecojoko_j6_kwh ---
    - name: "Ecojoko J6 kWh"
      unique_id: ecojoko_j6_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ states('sensor.ecojoko_j5_kwh') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=6)).strftime('%A %d/%m') }}"
        hp_kwh: "{{ state_attr('sensor.ecojoko_j5_kwh', 'hp_kwh') | float(0) | round(2) }}"
        hc_kwh: "{{ state_attr('sensor.ecojoko_j5_kwh', 'hc_kwh') | float(0) | round(2) }}"

    # --- ecojoko_j7_kwh ---
    # = Même jour de la semaine dernière (ex: Dimanche → Dimanche J-7)
    - name: "Ecojoko J7 kWh"
      unique_id: ecojoko_j7_kwh
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total
      restore: true
      state: >
        {{ states('sensor.ecojoko_j6_kwh') | float(0) | round(2) }}
      attributes:
        jour: "{{ (now() - timedelta(days=7)).strftime('%A %d/%m') }}"
        hp_kwh: "{{ state_attr('sensor.ecojoko_j6_kwh', 'hp_kwh') | float(0) | round(2) }}"
        hc_kwh: "{{ state_attr('sensor.ecojoko_j6_kwh', 'hc_kwh') | float(0) | round(2) }}"