# ╭────────────────────────────────────────────────────────────────────────╮
# │ SENSOR : DIAGNOSTIC ÉNERGÉTIQUE — 7 POSTES (MOIS) — VERSION RE-BUILD   │
# ╰────────────────────────────────────────────────────────────────────────╯

- sensor:
    # ┌───────────────────────────────────┐
    # │ 1. POSTES DÉTAILLÉS               │
    # └───────────────────────────────────┘
    # --- diag_poste_1_hygiene_mensuel ---
    - name: "Diag Poste 1 Hygiene mensuel"
      unique_id: diag_poste_1_hygiene_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:washing-machine
      state: >
        {{ (states('sensor.prise_lave_linge_nous_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_lave_vaisselle_nous_mensuel_kwh_um') | float(0) +
            states('sensor.prise_bureau_fer_a_repasser_nous_mensuel_kwh_um') | float(0)) | round(3) }}

    # --- diag_poste_2_cuisson_mensuel ---
    - name: "Diag Poste 2 Cuisson mensuel"
      unique_id: diag_poste_2_cuisson_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:stove
      state: >
        {{ (states('sensor.prise_four_micro_ondes_nous_mensuel_kwh_um') | float(0) +
            states('sensor.prise_petit_dejeune_nous_mensuel_kwh_um') | float(0) +
            states('sensor.prise_airfryer_ninja_nous_mensuel_kwh_um') | float(0) +
            states('sensor.four_et_plaque_de_cuisson_mensuel_kwh_um') | float(0)) | round(3) }}

    # --- diag_poste_3_froid_mensuel ---
    - name: "Diag Poste 3 Froid mensuel"
      unique_id: diag_poste_3_froid_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:fridge
      state: >
        {{ (states('sensor.prise_frigo_cuisine_nous_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_congelateur_cuisine_nous_mensuel_kwh_um') | float(0)) | round(3) }}

    # --- diag_poste_4_chauffage_mensuel ---
    - name: "Diag Poste 4 Chauffage mensuel"
      unique_id: diag_poste_4_chauffage_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:fire
      state: >
        {{ states('sensor.conso_clim_rad_total_mensuel_kwh_um') | float(0) | round(3) }}

    # --- diag_poste_5_multimedia_mensuel ---
    - name: "Diag Poste 5 Multimedia mensuel"
      unique_id: diag_poste_5_multimedia_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:monitor-dashboard
      state: >
        {{ (states('sensor.prise_box_internet_ikea_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_pc_s_gege_ikea_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_bureau_pc_ikea_mensuel_kwh_um') | float(0) +
            states('sensor.prise_tv_chambre_nous_mensuel_kwh_um') | float(0)) | round(3) }}

    # --- diag_poste_6_lumiere_mensuel ---
    - name: "Diag Poste 6 Lumiere mensuel"
      unique_id: diag_poste_6_lumiere_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:lightbulb
      state: >
        {{ states('sensor.eclairage_total_unit_mensuel_kwh_um') | float(0) | round(3) }}

    # --- diag_poste_7_autres_mensuel ---
    - name: "Diag Poste 7 Autres mensuel"
      unique_id: diag_poste_7_autres_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state_class: total_increasing
      icon: mdi:plus-circle-outline
      state: >
        {{ (states('sensor.all_standby_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_tete_de_lit_chambre_mensuel_kwh_um') | float(0) + 
            states('sensor.prise_salon_chargeur_nous_mensuel_kwh_um') | float(0) +
            states('sensor.prise_horloge_ikea_mensuel_kwh_um') | float(0)) | round(3) }}

    # ┌───────────────────────────────────┐
    # │ 2. SYNTHÈSE ET DYNAMIQUE          │
    # └───────────────────────────────────┘
    - name: "Max Conso Mensuelle Dynamique"
      unique_id: max_conso_mensuelle_dynamique
      unit_of_measurement: "kWh"
      state: >
        {% set p1 = states('sensor.diag_poste_1_hygiene_mensuel') | float(0) %}
        {% set p2 = states('sensor.diag_poste_2_cuisson_mensuel') | float(0) %}
        {% set p3 = states('sensor.diag_poste_3_froid_mensuel') | float(0) %}
        {% set p4 = states('sensor.diag_poste_4_chauffage_mensuel') | float(0) %}
        {% set p5 = states('sensor.diag_poste_5_multimedia_mensuel') | float(0) %}
        {% set p6 = states('sensor.diag_poste_6_lumiere_mensuel') | float(0) %}
        {% set p7 = states('sensor.diag_poste_7_autres_mensuel') | float(0) %}
        {{ ([p1, p2, p3, p4, p5, p6, p7] | max + 10) | round(3) }}

    - name: "Diag Conso Totale Identifiee mensuel"
      unique_id: diag_conso_totale_identifiee_mensuel
      unit_of_measurement: "kWh"
      device_class: energy
      state: >
        {% set p1 = states('sensor.diag_poste_1_hygiene_mensuel') | float(0) %}
        {% set p2 = states('sensor.diag_poste_2_cuisson_mensuel') | float(0) %}
        {% set p3 = states('sensor.diag_poste_3_froid_mensuel') | float(0) %}
        {% set p4 = states('sensor.diag_poste_4_chauffage_mensuel') | float(0) %}
        {% set p5 = states('sensor.diag_poste_5_multimedia_mensuel') | float(0) %}
        {% set p6 = states('sensor.diag_poste_6_lumiere_mensuel') | float(0) %}
        {% set p7 = states('sensor.diag_poste_7_autres_mensuel') | float(0) %}
        {{ (p1 + p2 + p3 + p4 + p5 + p6 + p7) | round(2) }}