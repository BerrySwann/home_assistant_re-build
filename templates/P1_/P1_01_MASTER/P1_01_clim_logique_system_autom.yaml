# ╭────────────────────────────────────────────────────────────────────────────────────────╮
# │ TEMPLATES : SÉRIE 03_05. -=<( SYSTEM CLIM - LOGIQUE COMPLETE )>=-                      │
# ╰────────────────────────────────────────────────────────────────────────────────────────╯

- sensor:
# ┌───────────────────────────────────────────────────────────────────┐
# │ DÉTECTION DU MODE GÉNÉRAL ET CONSIGNES DYNAMIQUES                 │
# └───────────────────────────────────────────────────────────────────┘

# --- mode_ete_hiver ---
# DÉTECTION DU MODE GÉNÉRAL
    - name: "Mode Été/Hiver"
      unique_id: mode_ete_hiver
      state: >
        {% set temp_ext = states('sensor.th_balcon_nord_temperature') | float(-999) %}
        {% set temp_no_chauf = states('sensor.seuil_non_chauffage_bas') | float(-999) %}
        {% if temp_ext == -999 or temp_no_chauf == -999 %}
          ERREUR
        {% elif temp_ext < temp_no_chauf %}
          heat
        {% elif temp_no_chauf <= temp_ext < 28 %}
          fan_only
        {% else %}
          cool
        {% endif %}

# --- consigne_de_base ---
# CONSIGNES DYNAMIQUES (Le coeur de la modification)
# Hiver: 18° / Été: 28°
    - name: "Consigne de Base"
      unique_id: consigne_de_base
      unit_of_measurement: "°C"
      state: >
        {% if states('sensor.mode_ete_hiver') == 'cool' %} 28 {% else %} 18 {% endif %}

# --- temperature_differentielle ---
# Temperature différentielle
# Hiver: 19° / Été: 27°
    - name: "Temperature différentielle"
      unique_id: temperature_differentielle
      unit_of_measurement: "°C"
      state: >
        {% if states('sensor.mode_ete_hiver') == 'cool' %} 27 {% else %} 19 {% endif %}

# ┌───────────────────────────────────────────────────────────────────┐
# │ PARAMÈTRES FIXES ET DELTAS DE CALCUL                              │
# └───────────────────────────────────────────────────────────────────┘

# --- temperature_eco_hiver ---
    - name: "Temperature éCO. Hiver"
      unique_id: temperature_eco_hiver
      unit_of_measurement: "°C"
      state: "17"

# --- seuil_non_chauffage_bas ---
    - name: "Seuil non chauffage bas"
      unique_id: seuil_non_chauffage_bas
      unit_of_measurement: "°C"
      state: "18"

# --- deltas_fixes ---
    - name: "Delta_1"
      unique_id: delta_1
      state: "1"
      unit_of_measurement: "°C"

    - name: "Delta_2"
      unique_id: delta_2
      state: "2"
      unit_of_measurement: "°C"

    - name: "Delta_3"
      unique_id: delta_3
      state: "3"
      unit_of_measurement: "°C"

    - name: "Delta_5"
      unique_id: delta_5
      state: "5"
      unit_of_measurement: "°C"

    - name: "Delta_7"
      unique_id: delta_7
      state: "7"
      unit_of_measurement: "°C"

# ┌───────────────────────────────────────────────────────────────────┐
# │ CORRECTIONS SPÉCIFIQUES (HIVERNALES)                              │
# └───────────────────────────────────────────────────────────────────┘

# ┌─────────────────────────────────────┐
# │ 04. SALON                           │
# └─────────────────────────────────────┘
# --- temperature_corrige_mamour_hivers ---
    - name: "Temperature Corrigé Mamour Hivers"
      unique_id: "temperature_corrige_mamour_hivers"
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {% set temp_conf_m = states('sensor.temperature_confort_jour') | float(20) %}
        {% set delta_1 = states('sensor.delta_1') | float(1) %}
        {% if states('sensor.mode_ete_hiver') == 'cool' %}
          {{ temp_conf_m }}
        {% else %}
          {% set resultat = temp_conf_m + delta_1 %}
          {{ [ resultat | float(20), 21.0 ] | min | round(1) }}
        {% endif %}

# ┌─────────────────────────────────────┐
# │ 07. BUREAU                          │
# └─────────────────────────────────────┘
# --- temperature_corrige_eric_hivers ---
    - name: "Temperature Corrigé Eric Hivers"
      unique_id: "temperature_corrige_eric_hivers"
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {% set temp_conf_e = states('sensor.temperature_confort_jour') | float(18) %}
        {% set delta_2 = states('sensor.delta_2') | float(2) %}
        {% if states('sensor.mode_ete_hiver') == 'cool' %}
          {{ temp_conf_e }}
        {% else %}
          {% set resultat = temp_conf_e - delta_2 %}
          {{ [ resultat | float(17), 18.0 ] | min | round(1) }}
        {% endif %}

# ┌─────────────────────────────────────┐
# │ 09. CHAMBRE                         │
# └─────────────────────────────────────┘
# --- temperature_corrige_chambre_hivers ---
    - name: "Temperature Corrigé Chambre Hivers"
      unique_id: temperature_corrige_chambre_hivers
      unit_of_measurement: "°C"
      device_class: temperature
      state: >
        {% set temp_conf_c = states('sensor.consigne_de_base') | float(0) %}
        {% if is_state('sensor.mode_ete_hiver', 'cool') %}
          {% set temp_conf_c = states('sensor.temperature_confort_jour') | float(0) %}
        {% endif %}
        {{ temp_conf_c }}

# ┌───────────────────────────────────────────────────────────────────┐
# │ MOTEURS DE CALCUL DYNAMIQUES (CIBLE / CONFORT)                    │
# └───────────────────────────────────────────────────────────────────┘

# --- temperature_cible ---
    - name: "Temperature Cible"
      unique_id: temperature_cible
      unit_of_measurement: "°C"
      state: >
        {% set temp_ext = states('sensor.th_balcon_nord_temperature') | float (0) | int (0) %}
        {% set consigne_de_base = states('sensor.consigne_de_base') | int (0) %}
        {% set delta_1 = states('sensor.delta_1') | int (0) %}
        {% set delta_2 = states('sensor.delta_2') | int (0) %}
        {% set delta_3 = states('sensor.delta_3') | int (0) %}
        {% set delta_5 = states('sensor.delta_5') | int (0) %}
        {% set delta_7 = states('sensor.delta_7') | int (0) %}
        {% if temp_ext < 8 %} {{ consigne_de_base + delta_1 }}
        {% elif temp_ext < 10 %} {{ consigne_de_base + delta_1 }}
        {% elif temp_ext < 12 %} {{ consigne_de_base + delta_1 }}
        {% elif temp_ext > 40 %} {{ temp_ext - delta_7 }}
        {% elif temp_ext > 32 %} {{ temp_ext - delta_5 }}
        {% else %} {{ consigne_de_base }}
        {% endif %}

# --- temperature_confort_jour ---
    - name: "Temperature confort Jour"
      unique_id: temperature_confort_jour
      unit_of_measurement: "°C"
      state: >
        {% set temp_diff = states('sensor.temperature_differentielle') | int (0) %}
        {% set consigne_de_base = states('sensor.consigne_de_base') | int (0) %}
        {% set temp_cible = states('sensor.temperature_cible') | int (0) %}
        {{ (temp_diff + (temp_cible - consigne_de_base)) | round(1) | int( 0) }}

# --- temperature_confort_nuit ---
    - name: "Temperature confort nuit"
      unique_id: temperature_confort_nuit
      unit_of_measurement: "°C"
      state: >
        {% set temp_ext = states('sensor.th_balcon_nord_temperature') | int (0) %}
        {% set temp_diff = states('sensor.temperature_differentielle') | int (0) %}
        {% set consigne_de_base = states('sensor.consigne_de_base') | int (0) %}
        {% set temp_cible = states('sensor.temperature_cible') | int (0) %}
        {% set delta_1 = states('sensor.delta_1') | int (0) %}
        {% set delta_2 = states('sensor.delta_2') | int (0) %}
        {% set delta_3 = states('sensor.delta_3') | int (0) %}
        {% set delta_5 = states('sensor.delta_5') | int (0) %}
        {% set delta_7 = states('sensor.delta_7') | int (0) %}
        {% if   temp_ext < 8  %} {{ ((temp_diff + (temp_cible - consigne_de_base)) - delta_1) | int (0) }}
        {% elif temp_ext < 10 %} {{ ((temp_diff + (temp_cible - consigne_de_base)) - delta_2) | int (0) }}
        {% elif temp_ext < 12 %} {{ ((temp_diff + (temp_cible - consigne_de_base)) - delta_2) | int (0) }}
        {% elif temp_ext < 19 %} {{ ((temp_diff + (temp_cible - consigne_de_base)) - delta_1) | int (0) }}
        {% elif temp_ext > 40 %} {{ temp_ext - delta_7 | int (0) }}
        {% elif temp_ext > 32 %} {{ temp_ext - delta_5 | int (0) }}
        {% else %} {{ (temp_diff + (temp_cible - consigne_de_base)) | int (0) }}
        {% endif %}

# --- temperature_eco_hiver_corrige ---
    - name: "Temperature éCO. Hiver Corrigé"
      unique_id: temperature_eco_hiver_corrige
      unit_of_measurement: "°C"
      state: >
        {% set temp_ext = states('sensor.th_balcon_nord_temperature') | float(0) %}
        {% set temp_eco = states('sensor.temperature_eco_hiver') | float(0) %}
        {% set delta_1 = states('sensor.delta_1') | float(0) %}
        {% set delta_2 = states('sensor.delta_2') | float(0) %}
        {% set delta_3 = states('sensor.delta_3') | float(0) %}
        {% if temp_ext < 8 %}
          {{ (temp_eco + delta_2) | float(19) }}
        {% elif temp_ext < 10 %}
          {{ (temp_eco + delta_1) | float(18) }}
        {% elif temp_ext < 12 %}
          {{ (temp_eco + delta_1) | float(18) }}
        {% else %}
          {{ temp_eco | float(0) }}
        {% endif %}

# ┌───────────────────────────────────────────────────────────────────┐
# │ MOYENNES, DELTAS INTERNES ET RECOMMANDATIONS ADEME                │
# └───────────────────────────────────────────────────────────────────┘

# --- temperature_moyenne_interieure ---
    - name: "Température moyenne intérieure"
      unique_id: temperature_moyenne_interieure
      unit_of_measurement: "°C"
      icon: "mdi:home-thermometer"
      state: >
        {% set s = states('sensor.th_salon_temperature') | float(0) %}
        {% set ce = states('sensor.th_cellier_temperature') | float(0) %}
        {% set ku = states('sensor.th_cuisine_temperature') | float(0) %}
        {% set bu = states('sensor.th_bureau_temperature') | float(0) %}
        {% set sdb = states('sensor.th_salle_de_bain_temperature') | float(0) %}
        {% set ch = states('sensor.th_chambre_temperature') | float(0) %}
        {{ ((s + ce + ku + bu + sdb + ch) / 6) | round(1) }}

# --- temperature_delta_value ---
    - name: "Temperature Delta (valeur)"
      unique_id: temperature_delta_value
      unit_of_measurement: "°C"
      state: >
        {# CALCUL : INTERIEUR - EXTERIEUR pour avoir une valeur positive #}
        {% set t_int = states('sensor.temperature_moyenne_interieure') | float(0) %}
        {% set t_ext = states('sensor.th_balcon_nord_temperature') | float(0) %}
        {{ (t_int - t_ext) | round(1) }}

# --- temperature_delta (AFFICHAGE) ---
    - name: "Température Delta (Affichage)"
      unique_id: temperature_delta_affichage
      state: >
        T̄i {{ states('sensor.temperature_moyenne_interieure') | float(0) | round(1) }}°C 
        Te {{ states('sensor.th_balcon_nord_temperature') | float(0) | round(1) }}°C 
        ΔT = {{ (states('sensor.temperature_moyenne_interieure') | float(0) - states('sensor.th_balcon_nord_temperature') | float(0)) | round(1) }}°C

# --- delta_ademe_recommande ---
    - name: "Delta ADEME Recommandé"
      unique_id: delta_ademe_recommande
      unit_of_measurement: "°C"
      icon: "mdi:delta"
      state: >
        {{ (states('sensor.temperature_confort') | float(0) - 
            states('sensor.th_balcon_nord_temperature') | float(0)) | round(1) }}