# â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
# â”‚ COMMAND_LINE : GITHUB (MAINTENANCE)                              â”‚
# â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

# --- backup_github_status ---
- sensor:
    name: "Backup GitHub Status"
    unique_id: backup_github_status
    command: >-
      bash -lc 'LOG=/config/.logs/ha_git_backup.log;
      if [ -s "$LOG" ] && grep -E "Push rÃ©ussi|Ã‰tat dÃ©jÃ  Ã  jour" "$LOG" >/dev/null 2>&1; then
        TS=$(grep -E "Push rÃ©ussi|Ã‰tat dÃ©jÃ  Ã  jour" "$LOG" | tail -n1 | awk "{print \$1, \$2}");
        printf "{\"ok\":true,\"ts\":\"%s\"}\n" "$TS";
      else
        echo "{\"ok\":false,\"ts\":\"\"}";
      fi'
    scan_interval: 60
    value_template: "{{ 'OK' if value_json.ok else 'KO' }}"
    json_attributes:
      - ts

# --- git_last_weekly_tag ---
- sensor:
    name: "Git Last Weekly Tag"
    unique_id: git_last_weekly_tag
    command: "bash -lc 'cd /config && git tag --list \"weekly-*\" | sort | tail -n1 || true'"
    scan_interval: 1800

# --- backup_github_journal ---
- sensor:
    name: "backup_github_journal"
    unique_id: backup_github_journal
    command: >-
      bash -c 'LOG=/config/.logs/ha_git_backup.log;
      if [ -s "$LOG" ]; then
        OUT=$(grep -aE "âœ…|âŒ|ðŸ“|ðŸ·ï¸|ABANDON|error:|declined|failed|Git pull" "$LOG" | tail -n 10);
        if [ -z "$OUT" ]; then
          echo "{\"text\":\"Aucune activitÃ© pertinente trouvÃ©e\"}";
        else
          echo "{\"text\": $(echo "$OUT" | jq -Rs .)}";
        fi
      else
        echo "{\"text\":\"Fichier de log introuvable\"}";
      fi'
    value_template: "ready"
    json_attributes:
      - text
    scan_interval: 60

# --- github_default_branch ---
- sensor:
    name: "GitHub Default Branch"
    unique_id: github_default_branch
    # âš ï¸ ModifiÃ© pour pointer sur le nouveau dÃ©pÃ´t v2.0
    command: >-
      bash -lc 'curl -s -H "User-Agent: HAOS" https://api.github.com/repos/BerrySwann/home_assistant_re-build |
      grep -m1 "\"default_branch\"" |
      sed -E '\''s/.*"default_branch":[[:space:]]*"([^"]*)".*/\1/'\'''
    scan_interval: 3600
    value_template: >-
      {{ value if value not in [None, "", "null"] else "unknown" }}